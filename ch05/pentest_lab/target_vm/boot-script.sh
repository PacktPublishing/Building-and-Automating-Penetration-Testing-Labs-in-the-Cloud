#!/bin/bash

sleep 30

echo "FLAG # 1!" > /root/flag1.txt

echo "STEP: INSTALL DOCKER"
snap install docker

sleep 10

echo "STEP: PULL METASPLOITABLE CONTAINER"
sudo docker pull tleemcjr/metasploitable2:latest

sleep 10

echo "STEP: RUN CONTAINER"
sudo docker run -d --name testsploitable --privileged -it \
  -p 3632:3632 \
  -p 8009:8009 \
  -p 8180:8180 \
  -p 3306:3306 \
  -p 6667:6667 \
  -p 6697:6697 \
  -p 6000:6000 \
  -p 5900:5900 \
  -p 1099:1099 \
  -p 42179:42179 \
  -p 5432:5432 \
  -p 1524:1524 \
  -p 8787:8787 \
  -p 514:514 \
  -p 513:513 \
  -p 512:512 \
  -p 111:111 \
  -p 23:23 \
  -p 2022:22 \
  -p 21:21 \
  -p 25:25 \
  -p 139:139 \
  -p 445:445 \
  tleemcjr/metasploitable2:latest \
  sh -c "/bin/services.sh && while true; do sleep 1000; done"

sleep 5

echo "STEP: INSTALL AZURE CLI"

curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

sleep 2

echo "STEP: AZ LOGIN"

az login --identity

sleep 2

echo "STEP: KEY VAULT SET UP FLAG"

az keyvault secret set --vault-name rg-01-key-vault --name "flag2" --value "FLAG # 2!"

echo "STEP: DONE"
